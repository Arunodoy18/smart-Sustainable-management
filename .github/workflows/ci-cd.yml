name: Production Build & Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY_NAME: waste-management-registry
  RESOURCE_GROUP: waste-management-rg
  BACKEND_APP: waste-backend
  FRONTEND_APP: waste-frontend

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Backend Validation
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Backend Dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pylint black
      
      - name: Lint Backend
        run: |
          cd backend
          black --check .
          pylint app/ --disable=C,R,W0611 || true

      # Frontend Validation
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install Frontend Dependencies
        run: |
          cd web
          npm ci

      - name: Lint Frontend
        run: |
          cd web
          npm run lint

  build-and-push:
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v1
        if: env.AZURE_CREDENTIALS != ''
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        env:
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log into Registry
        if: env.AZURE_CREDENTIALS != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.REGISTRY_LOGIN_SERVER }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      # Backend Build
      - name: Build and Push Backend
        if: env.AZURE_CREDENTIALS != ''
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.REGISTRY_LOGIN_SERVER }}/waste-backend:${{ github.sha }}

      # Frontend Build
      - name: Build and Push Frontend
        if: env.AZURE_CREDENTIALS != ''
        uses: docker/build-push-action@v5
        with:
          context: ./web
          push: true
          tags: ${{ secrets.REGISTRY_LOGIN_SERVER }}/waste-frontend:${{ github.sha }}
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            NEXT_PUBLIC_WS_URL=${{ secrets.NEXT_PUBLIC_WS_URL }}
            NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}

  deploy:
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
      - name: Log in to Azure
        uses: azure/login@v1
        if: env.AZURE_CREDENTIALS != ''
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        env:
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Container Apps
        if: env.AZURE_CREDENTIALS != ''
        uses: azure/container-apps-deploy-action@v1
        with:
          appSourcePath: ${{ github.workspace }}
          registryUrl: ${{ secrets.REGISTRY_LOGIN_SERVER }}
          registryUsername: ${{ secrets.REGISTRY_USERNAME }}
          registryPassword: ${{ secrets.REGISTRY_PASSWORD }}
          containerAppName: ${{ env.BACKEND_APP }}
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          imageToDeploy: ${{ secrets.REGISTRY_LOGIN_SERVER }}/waste-backend:${{ github.sha }}
