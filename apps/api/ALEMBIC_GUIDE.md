# Alembic Migration Guide - Smart Waste AI

This guide documents the Alembic migration workflow for the Smart Waste AI project. Following these guidelines will prevent migration chain corruption and deployment failures.

## Quick Reference

```bash
# Check current migration state
alembic current

# View migration history
alembic history --verbose

# Apply all pending migrations
alembic upgrade head

# Rollback one migration
alembic downgrade -1

# Generate new migration from model changes
alembic revision --autogenerate -m "description"

# Generate SQL without applying (for review)
alembic upgrade head --sql > migration.sql
```

## Critical Rules

### ⛔ NEVER Do These Things

1. **NEVER rename migration files** after they've been committed or applied
   - Alembic tracks migrations by revision ID in the filename
   - Renaming breaks the revision chain

2. **NEVER delete migration files**
   - Even if you think they're wrong
   - Create a new migration to reverse changes instead

3. **NEVER modify an applied migration**
   - Once a migration has run on any database, treat it as immutable
   - Create a new migration for any corrections

4. **NEVER change enum values after they exist in the database**
   - PostgreSQL enums are immutable
   - To change values, you must create new enum types and migrate data

### ✅ ALWAYS Do These Things

1. **ALWAYS review autogenerated migrations**
   - Alembic can generate incorrect or dangerous migrations
   - Check for accidental table drops or data loss

2. **ALWAYS test migrations locally first**
   - Run `alembic upgrade head` on a local database
   - Verify the app still works

3. **ALWAYS backup production database before migrating**
   - Migrations can fail midway, leaving the database in a broken state

4. **ALWAYS run migrations manually in production**
   - Do not auto-run migrations on app startup
   - This gives you control and visibility

## Standard Workflow

### Adding a New Feature

```bash
# 1. Make changes to your model files (src/models/*.py)
# 2. Generate migration
alembic revision --autogenerate -m "add user preferences table"

# 3. Review the generated file in alembic/versions/
# 4. Test locally
alembic upgrade head

# 5. Verify the app works
python -m pytest

# 6. Commit everything
git add .
git commit -m "feat: add user preferences with migration"

# 7. Deploy to staging, then production
# 8. On production server, run:
alembic upgrade head
```

### Checking Migration Status

```bash
# Show current applied migration
alembic current

# Expected output for a healthy database:
# a1b2c3d4e5f6 (head)

# Show full history
alembic history --verbose
```

## Recovery Procedures

### Scenario: Deployment Failed Due to Migration Error

1. **Check the current state:**
   ```bash
   alembic current
   ```

2. **If migration partially applied, rollback:**
   ```bash
   alembic downgrade -1
   ```

3. **Fix the migration file and retry:**
   ```bash
   alembic upgrade head
   ```

### Scenario: alembic_version Table Out of Sync

This happens when the database schema was modified outside of Alembic.

```bash
# WARNING: Only use this if you're CERTAIN the schema matches the migration
alembic stamp head
```

This marks all migrations as applied without actually running them.

### Scenario: Need to Start Fresh (Development Only!)

```bash
# Drop all tables and recreate
alembic downgrade base
alembic upgrade head
```

⚠️ **NEVER do this in production!**

## Enum Handling

PostgreSQL enums are created once and are **immutable**. The project uses UPPERCASE enum values:

```python
class UserRole(str, enum.Enum):
    CITIZEN = "CITIZEN"  # Matches PostgreSQL: 'CITIZEN'
    DRIVER = "DRIVER"    # Matches PostgreSQL: 'DRIVER'
    ADMIN = "ADMIN"      # Matches PostgreSQL: 'ADMIN'
```

### Adding New Enum Values

To add a new value to an existing enum, create a migration:

```python
def upgrade():
    # Add new enum value
    op.execute("ALTER TYPE user_role ADD VALUE 'SUPER_ADMIN'")

def downgrade():
    # PostgreSQL doesn't support removing enum values easily
    # You'd need to recreate the enum type and migrate data
    pass
```

### Changing Enum Values

This is complex and risky. You must:
1. Create a new enum type
2. Add a new column with the new type
3. Migrate data from old column to new column
4. Drop old column
5. Rename new column
6. Drop old enum type

## File Naming Convention

Alembic migration files MUST follow this pattern:
```
<revision_id>_<short_description>.py
```

Examples:
- `3b11939b5277_initial_schema.py`
- `a1b2c3d4e5f6_add_user_preferences.py`

The revision ID is a 12-character hex string generated by Alembic.

## Troubleshooting

### "Target database is not up to date"

```bash
# Check what's pending
alembic history
alembic current

# Apply pending migrations
alembic upgrade head
```

### "Can't locate revision identified by 'xxxxx'"

The revision ID in the database doesn't match any migration file. This usually means:
- A migration file was deleted
- A migration file was renamed
- You're on the wrong branch

Recovery:
```bash
# See what the database thinks is current
alembic current

# If you need to force sync (dangerous!)
alembic stamp head
```

### "Enum 'xxx' already exists"

The migration is trying to create an enum that already exists. This happens when:
- You ran the migration partially before
- You manually created the enum

Fix by modifying the migration to check if the enum exists first.

## Production Deployment Checklist

- [ ] Reviewed the migration file
- [ ] Tested migration on local database
- [ ] Tested migration on staging environment
- [ ] Backed up production database
- [ ] Scheduled deployment during low-traffic period
- [ ] Have rollback plan ready
- [ ] Run `alembic upgrade head` on production
- [ ] Verify application works
- [ ] Monitor for errors

## Support

If you encounter migration issues:
1. Check `alembic current` and `alembic history`
2. Review the error message carefully
3. Check if the database schema matches expected state
4. Consult this guide for recovery procedures
5. Ask for help before making manual database changes
